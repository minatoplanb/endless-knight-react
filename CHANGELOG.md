# Changelog

所有專案的重要變更都會記錄在這個檔案中。

格式基於 [Keep a Changelog](https://keepachangelog.com/zh-TW/1.0.0/)。

---

## [v1.3.2] - 2026-02-05

### 新增
- **怪物素材系統（Monster Parts System）**
  - 敵人掉落怪物素材而非裝備（學習 Melvor Idle）
  - 普通敵人：資源 + 普通素材（🦴）+ 稀有素材（💎，2%機率）
  - Boss：大量資源 + 保證掉落所有素材 + 15%機率掉裝備
  - 新增 `MonsterPartsState` 類型：common_part, rare_part, boss_part

- **製作配方使用怪物素材**
  - 基礎裝備：僅需資源
  - 中階裝備：資源 + 普通素材（鋼劍、鋼甲、長弓、獵人甲等）
  - 高階裝備：資源 + 普通素材 + 稀有素材（戰斧、魔法杖等）
  - 詞條裝備：資源 + 稀有素材（財富戒指、吸血護符、荊棘盾）
  - 傳說裝備：資源 + 稀有素材 + Boss 素材（屠龍劍）

- **製作頁面更新**
  - 顯示怪物素材庫存（🦴/💎/👑）
  - 顯示配方的怪物素材需求
  - 材料不足時顯示紅色提示

- **戰鬥三角系統強化（Combat Triangle Enhancement）**
  - 戰鬥優勢/劣勢倍率從 1.5x 提升至 2.0x（更具策略性）
  - 玩家角色根據戰鬥風格顯示顏色光環
    - 近戰（紅色 #ff6b6b）
    - 遠程（青色 #4ecdc4）
    - 魔法（紫色 #a855f7）
  - 戰鬥指示器文字更新：「優勢 2倍傷害」/「劣勢 受2倍傷害」
  - CombatStyleSelector 新增 i18n 支援（中/英文切換）
  - 修正戰鬥風格選擇器顯示的倍率：+50%/-50% → +100%/-100%

- **暴擊視覺效果強化（Critical Hit Visual Enhancement）**
  - 暴擊傷害數字加入震動效果（水平抖動動畫）
  - 暴擊起始縮放從 1.5x 提升至 2.0x
  - 暴擊傷害上方顯示 "CRIT!" 標籤
  - 暴擊傷害後方新增爆炸 emoji（💥）

- **自動技能系統（Auto-Skill System）**
  - 新增自動技能開關（設定頁面）
  - 技能冷卻完畢時自動施放
  - 每次 tick 只施放一個技能，避免效果過載

- **戰鬥優勢傷害指示（Combat Advantage Indicator）**
  - 優勢攻擊顯示綠色傷害數字
  - 優勢攻擊上方顯示 "⬆️ 2x" 標籤
  - 優勢傷害起始縮放 1.3x

- **UI 改進**
  - 任務頁面領取按鈕改為 3D 立體風格（PressableButton）
  - 批量賣出按鈕修復為響應式設計
  - 新增「強化全部裝備」按鈕到裝備面板
  - 新增「最佳裝備」按鈕 - 自動從背包裝備最強物品
  - 製作頁面新增批量製作功能（消耗品可選擇數量）
  - 可製作的配方顯示綠色邊框指示

### 修復
- **轉生重置**：轉生時正確重置怪物素材
- **存檔相容**：舊存檔自動遷移，初始化怪物素材為 0
- **批量賣出**：修復按鈕點擊無反應問題

---

## [v1.3.1] - 2026-02-04

### 新增
- **觸覺/音效反饋系統（Haptic Feedback System）**
  - 新增 `AudioManager` 管理觸覺和音效反饋
  - 安裝 `expo-haptics` 和 `expo-av` 套件
  - 按鈕按下時提供觸覺反饋（手機震動）
  - 升級成功時提供成功反饋
  - 收取獎勵時提供金幣反饋
  - 導航切換時提供點擊反饋
  - 製作成功/失敗時提供對應反饋

- **按鈕視覺反饋大改進（Button Visual Feedback）**
  - 所有按鈕改用 3D 立體風格（底部邊框模擬深度）
  - 按下時按鈕「下沉」效果（borderBottomWidth 減少 + marginTop）
  - Web 端支援 hover 效果（背景色變亮）
  - 改進的縮放動畫（spring animation）
  - 影響元件：PressableButton, UpgradeButton, BottomNav, CraftingScreen

### 修復
- **修復法杖 icon 顯示問題**
  - 將 `🪄` 改為 `🔮`（某些設備無法顯示魔法棒 emoji）
  - 影響：木杖、魔法杖配方和裝備圖示

---

## [v1.3.0] - 2026-02-04

### 新增
- **製造系統大改版（Crafting System Overhaul）**
  - 學習 Melvor Idle 設計理念，讓製造系統變成核心玩法

- **製作專屬詞條系統（Crafting Affixes）**
  - 新增 6 種製作專屬詞條：
    - 採集加速（gathering_boost）：特定資源採集速度 +X%
    - 金幣獵人（gold_find）：金幣掉落 +X%
    - 生命汲取（life_steal）：攻擊回復 X% 傷害為 HP
    - 荊棘（thorns）：受擊反彈 X% 傷害
    - 屠龍者（boss_slayer）：對 Boss +X% 傷害
    - 節約大師（resource_saver）：製作時 X% 機率不消耗資源
  - 新增詞條裝備配方：財富戒指、吸血護符、荊棘盾、屠龍劍

- **採集工具系統（Gathering Tools）**
  - 新增 8 種採集工具：
    - 鐵鎬/鋼鎬：礦石採集 +25%/+50%
    - 伐木斧/精鋼斧：木材採集 +25%/+50%
    - 釣竿/精良釣竿：魚獲採集 +25%/+50%
    - 鐮刀/精良鐮刀：草藥採集 +25%/+50%
  - 工具通過製作獲得，自動裝備到對應資源欄位
  - 工具加成與詞條加成疊加

- **製作等級系統（Crafting Levels）**
  - 每個製作類別獨立等級（鍛造、製箭、烹飪、煉金）
  - 製作獲得經驗值，升級解鎖高級配方
  - 等級效果：
    - 每級 +5% 製作品質
    - 等級 15：10% 機率雙倍產出
    - 等級 20：20% 機率不消耗資源
  - 配方有等級需求限制

- **Boss 強化（Boss Difficulty Increase）**
  - Boss 攻擊力倍率大幅提升：
    - Area 1：5x → 8x
    - Area 2：6x → 10x
    - Area 3：8x → 14x
    - Area 4：10x → 18x
    - Area 5：12x → 22x
  - 需要使用消耗品才能有效挑戰 Boss

- **死亡懲罰（Death Penalty）**
  - 死亡損失 10% 金幣
  - 復活時只有 50% HP（不是滿血）

### 變更
- 存檔版本升級至 `1.3.0`
- `types/index.ts` 新增 AffixType, Affix, CraftingProgress 型別
- `GatheringState` 新增 equippedTools 欄位
- `Equipment` 新增 affixes 欄位
- `useGameStore` 新增詞條效果計算、工具加成、製作經驗系統

### 新增檔案
- `src/data/affixes.ts` — 詞條定義和 helper 函數

---

## [Unreleased]

### 新增
- **批量販賣功能（Bulk Sell Feature）**
  - 新增 `BulkSellPanel` 組件到裝備頁面
  - 一鍵賣出普通+優良裝備
  - 按稀有度分類販賣（普通、優良、稀有、史詩）
  - 販賣前顯示數量和預計金幣
  - 確認對話框防止誤操作

- **按鈕觸控反饋優化（Button Press Feedback）**
  - 新增 `PressableButton` 共用組件
  - 按下時有彈性縮放動畫（0.92x）
  - 支援 primary、success、danger、secondary 變體
  - 已套用到 DeathModal、OfflineModal、WorkerCard、ResourceBar

- **i18n 擴展（i18n Extensions）**
  - 採集頁面：標題和副標題支援中英文
  - 工人卡片：採集速率支援中英文
  - 離線獎勵彈窗：完整中英文支援
  - 掉落通知：完整中英文支援（稀有度、欄位、屬性）
  - 新增 RARITY_NAMES_EN、SLOT_NAMES_EN 常量

- **採集工人等級擴展（Worker Level Extension）**
  - 工人最高等級從 5 級擴展到 20 級
  - 漸進式成本縮放，保持遊戲平衡
  - 等級 1-5：早期遊戲，便宜
  - 等級 6-10：中期遊戲
  - 等級 11-15：後期遊戲
  - 等級 16-20：終局遊戲

- **資源上限升級系統（Resource Cap Upgrade）**
  - 新增資源上限升級功能
  - 基礎上限 500，每級 +250
  - 最高 10 級，可達 3000 上限
  - 成本倍率 1.8x

- **Firebase 整合（Firebase Integration）**
  - 匿名登入（Anonymous Authentication）
  - 雲端存檔（Cloud Firestore）
  - Analytics 分析追蹤
  - 設定頁面新增「雲端同步」功能
  - 本地存檔保持為主要存儲，雲端為備份
  - 新增 `src/services/firebase.ts` 服務模組
  - 新增 `src/hooks/useFirebase.ts` React Hook
  - 新增 `FIREBASE_SETUP.md` 設定指南

### 修復
- **敵人防禦計算修復（Enemy Defense Fix）**
  - 修正敵人防禦計算，現在正確使用敵人的 `def` 屬性
  - 之前錯誤地使用 `enemy.atk * 0.1` 作為防禦值
  - 影響：敵人難度更符合設計預期

- **區域效率系統實現（Area Efficiency System）**
  - 實現 CLAUDE.md 中定義的區域效率公式
  - 公式：`有效攻擊力 = 基礎攻擊 × (玩家等級 / (玩家等級 + 區域要求))`
  - 玩家等級 = 所有升級次數總和（HP + ATK + DEF + 速度 + 暴擊）
  - 影響：高等級區域現在需要更多升級才能有效率地戰鬥

- **掉落邏輯修復（Loot Drop Fix）**
  - 修正 `killEnemy()` 中的參數錯誤
  - 之前 `isStageComplete` 被錯誤當作 `isBoss` 參數傳入
  - 影響：普通敵人的掉落機率恢復正常（1% + 0.02% per stage）

### 新增
- **英文支援（English support / i18n）**
  - 新增 `src/locales`：`zh.ts`、`en.ts`、`index.ts`、`types.ts`
  - 語言選項儲存於 AsyncStorage（`@endless_knight_locale`），設定頁可切換 繁體中文 / English
  - UI 字串改為 `t(key)`；資料名稱（區域、敵人、Boss、技能、成就等）英文用 `getDataName(type, id, fallback)`
  - 已套用：底部導航、TopBar、設定頁、死亡彈窗、戰鬥畫面、升級面板與按鈕
  - 其餘畫面與資料 key 可依需求陸續補上

### 修復
- **回退圖示系統重構（Revert Icon System Refactoring）**
  - 移除 `src/constants/icons.ts` 集中式圖示管理系統
  - 恢復組件內部靜態圖示映射（EquipmentSlot, InventoryGrid, ItemDetail, LootModal）
  - 修復由動態 require 導致的效能問題和 lag
  - 修復裝備圖示錯誤（斧頭顯示為動物等問題）

### 新增
- **成就系統（Achievement System）**
  - 50+ 種成就，涵蓋戰鬥/進度/經濟/製作/技能/裝備/採集
  - 成就解鎖時顯示通知
  - 成就頁面顯示進度和獎勵
  - 成就獎勵：金幣、技能點、轉生點
  - 裝備類成就：追蹤強化次數（1/10/50/200 次）
  - 採集類成就：追蹤各種資源採集量（10/500/5000）

- **統計頁面（Statistics Page）**
  - 顯示所有追蹤的統計數據
  - 戰鬥/傷害/經濟/活動/時間統計

- **每日獎勵系統（Daily Rewards）**
  - 7 天連續登入獎勵循環
  - 獎勵隨天數遞增（金幣、技能點、資源、轉生點）
  - 錯過一天重置連續天數
  - 每日獎勵彈窗提示

- **設定頁面（Settings Page）**
  - 手動儲存功能
  - 查看遊戲統計
  - 重置遊戲選項
  - 版本資訊顯示
  - TopBar 新增設定按鈕

- **新區域：迷霧沼澤（Misty Swamp）**
  - 100 關卡，5 種敵人
  - Boss：沼澤之王
  - 使用 forest_winter 背景

- **新區域：烈焰地獄（Flame Hell）**
  - 100 關卡，5 種敵人
  - Boss：煉獄魔王（掉落傳說裝備）
  - 使用 hell 背景

- **技能系統（Skills System）**
  - 6 種主動技能：強力一擊、治療術、護盾、狂暴、鷹眼、黃金時刻
  - 技能有冷卻時間（10-30秒）
  - 技能可升級，最高 5-10 級
  - 擊敗 Boss 獲得技能點
  - 技能效果：
    - 即時傷害（強力一擊）
    - 即時治療（治療術）
    - 防禦 buff（護盾）
    - 攻速 buff（狂暴）
    - 暴擊 buff（鷹眼）
    - 金幣 buff（黃金時刻）
  - 技能欄顯示在戰鬥畫面
  - 技能頁面可升級/解鎖技能

- **戰鬥風格系統（Combat Style Triangle）**
  - 三種戰鬥風格：近戰、遠程、魔法
  - 剋制關係：近戰 > 遠程 > 魔法 > 近戰
  - 剋制時造成/受到 150% 傷害
  - 戰鬥風格選擇器顯示與當前敵人的相剋關係
  - 每個敵人都有預設的戰鬥風格

- **製作系統（Crafting System）**
  - 4 種製作類型：鍛造、製箭、烹飪、煉金
  - 使用採集資源製作物品
  - 配方包含：武器、防具、食物、藥水
  - 製作頁面（`/crafting`）

- **消耗品系統（Consumables System）**
  - 食物：恢復 HP（烤魚、魚湯、豪華大餐）
  - 藥水：提供增益效果（力量/防禦/速度藥水）
  - Buff 系統：增益效果有持續時間
  - 自動過期的 buff 追蹤

- **裝備販賣功能（Equipment Selling）**
  - 背包內裝備可販賣換取金幣
  - 販賣價格根據稀有度和等級計算
  - 稀有度基礎價格：普通10、優良25、稀有75、史詩200、傳說500
  - 等級加成：每級 +10% 基礎價格

- **裝備強化系統（Equipment Enhancement）**
  - 使用資源和金幣強化裝備
  - 每次強化提升 10% 屬性
  - 最大強化等級依稀有度：普通+5、優良+7、稀有+10、史詩+12、傳說+15
  - 成功率隨等級遞減（100% → 50%）
  - 強化失敗仍消耗資源
  - 裝備欄位和背包顯示強化等級標記

- **任務系統（Quest System）**
  - 每日任務：3 個隨機任務，每天重置
  - 每週任務：3 個隨機任務，每週重置
  - 任務類型：擊敗敵人、擊敗 Boss、獲得金幣、採集資源、製作物品、強化裝備、使用技能、使用消耗品
  - 任務獎勵：金幣、資源、技能點、轉生點
  - 自動追蹤任務進度

- **自動消耗品系統（Auto-Consume）**
  - 在設定頁面啟用/停用
  - 可設定 HP 閾值（20%-60%）
  - 選擇要自動使用的回復道具
  - 戰鬥中 HP 低於閾值時自動使用

- **轉生系統（Prestige System）**
  - 消耗進度換取轉生點數
  - 8 種永久升級：攻擊/防禦/生命/暴擊/速度/金幣/起始金/離線效率
  - 轉生點數計算基於：累計金幣、最高關卡、通關區域
  - 轉生重置：金幣、升級、裝備、區域進度、採集資源
  - 轉生保留：轉生點數、永久升級

- **Boss 戰系統**
  - 每個區域最終關卡出現 Boss
  - 5 個區域 Boss：史萊姆王、哥布林酋長、骷髏領主、沼澤之王、煉獄魔王
  - Boss 有更高的 HP/ATK/DEF（20-60 倍）
  - Boss 保證掉落裝備（最低稀有度根據區域）
  - Boss 專屬 UI：金色血條、放大顯示、稱號顯示

- **統計系統（Statistics Tracking）**
  - 追蹤總擊殺數、Boss 擊殺、死亡次數
  - 追蹤總傷害輸出/承受、暴擊次數
  - 追蹤總金幣獲得、遊戲時間
  - 追蹤最高單次傷害、最長連殺
  - 追蹤製作/消耗品/技能使用次數

### UI 改進
- **戰鬥風格效果指示器**
  - 顯示玩家 vs 敵人戰鬥風格
  - 顯示優勢/劣勢狀態（+50%/-50%）
  - 顏色編碼徽章（綠色優勢、紅色劣勢）

- **升級推薦系統**
  - 顯示「推薦」徽章在最有價值的升級上
  - 智能推薦基於死亡次數、遊戲階段、屬性平衡

- **移動階段視覺回饋**
  - 置中卡片顯示「前往下一個敵人」
  - 大型行走表情符號和金色進度條
  - 半透明背景不遮擋戰鬥場景

- **導航改進**
  - TopBar 新增成就按鈕（🏆）
  - TopBar 新增每日獎勵指示器（🎁 可領取時）
  - 底部導航任務按鈕新增通知徽章
  - 任務頁面顯示重置時間

- **頁面一致性**
  - 技能頁面新增 TopBar
  - 統計頁面新增採集/強化數據

- **Buff 狀態顯示**
  - 新增 BuffDisplay 元件顯示所有活躍增益
  - 同時顯示消耗品和技能增益
  - 色彩標記不同增益類型
  - 即時倒數計時器

### 修復
- **敵人圖片修復（Portrait → Sprite）**
  - 將所有敵人圖片從頭像改為全身像素圖
  - 修復的敵人：skeleton, skeleton_red, skeleton_gold, goblin, zombie, orc, bat, mushroom, rat, mimic
  - 所有敵人現在面向左邊（符合 CLAUDE.md 美術規範）

- **掉落通知可點擊關閉**
  - 裝備掉落通知現在可以點擊關閉
  - 不再阻擋玩家操作區域選擇器

### 平衡調整
- **難度大幅提升（學習 Melvor Idle）**
  - 每個區域增加到 100 關卡
  - Boss 難度提升 3-5 倍（HP/ATK/DEF 倍率大幅增加）
  - 裝備掉落率從 8% 降低到 1%，最高 5%
  - 升級基礎費用提升，效果減少
  - 敵人初始數值和成長曲線調整
  - 採集工人升級成本大幅提升
  - 技能解鎖/升級成本大幅提升（3-10 倍）

---

## [v0.5.0] - 2026-02-02

### 新增
- **採集系統**
  - 4 種工人：礦工、樵夫、漁夫、採集者
  - 4 種資源：礦石、木材、魚獲、草藥
  - 工人在背景自動採集（即使在其他分頁）
  - 工人升級功能（5 級，採集速度加快）
  - 資源倉庫（每種資源上限 500）
- **採集頁面** (`app/gathering.tsx`)
  - 工人卡片顯示等級、採集進度、升級按鈕
  - 資源倉庫面板顯示當前存量
- **離線採集收益**
  - 離線時工人繼續採集
  - 返回時顯示離線採集獎勵

### 變更
- 存檔版本升級至 `0.5.0`
- `useGameStore` 新增採集系統狀態和方法
- `types/index.ts` 新增 ResourceType、WorkerType、Worker、GatheringState 型別
- `OfflineModal` 現在顯示離線採集獎勵
- 底部導航新增「採集」分頁

### 新增檔案
- `src/data/resources.ts` — 資源類型定義
- `src/data/gathering.ts` — 工人和升級表定義
- `src/components/gathering/WorkerCard.tsx` — 工人卡片元件
- `src/components/gathering/ResourceBar.tsx` — 資源顯示元件
- `app/gathering.tsx` — 採集頁面

---

## [v0.4.0] - 2026-02-02

### 新增
- **區域系統**
  - 3 個初始區域：新手平原、陰暗森林、石壁高地
  - 每個區域有獨特的敵人池（3-5 種敵人）
  - 每個區域有專屬背景圖
  - 區域內關卡數：10/15/20 關
  - 敵人根據區域和關卡動態生成
- **區域選擇器** (`AreaSelector.tsx`)
  - 橫向滾動的區域按鈕列
  - 顯示區域進度和完成狀態
  - 未解鎖區域顯示鎖定圖示
- **區域解鎖機制**
  - 通關區域自動解鎖下一個區域
  - 區域進度獨立儲存
- **TopBar 更新**
  - 顯示區域名稱
  - 顯示「第 X/Y 關」格式
  - 完成區域顯示 ✓ 標記

### 變更
- 存檔版本升級至 `0.4.0`
- `useGameStore` 新增區域相關狀態和方法
- `types/index.ts` 新增 Area、AreaEnemy、AreaProgress 型別
- `BattleView` 改用區域資料決定背景和敵人
- 敵人現在有基於區域的名稱和數值

### 新增檔案
- `src/data/areas.ts` — 區域和敵人定義
- `src/components/ui/AreaSelector.tsx` — 區域選擇元件

### 文件
- **CLAUDE.md 新增「設計哲學」章節**
  - 核心理念：不要只是堆疊數字
  - 設計原則 5 條（牆=謎題、每個數字都重要、區域效率公式、裝備是解法、後台成長）
  - 參考遊戲研究：Melvor Idle、Soda Dungeon、Into the Breach
- **更新「遊戲數值」章節**
  - 新增區域係數傷害公式（future-proof DEF 系統）
  - 新增敵人數值範圍表（5 個區域）
  - 新增 DEF 減傷參考表

---

## [v0.3.0] - 2026-02-02

### 新增
- **裝備系統**
  - 6 種裝備欄位：武器、頭盔、盔甲、盾牌、戒指、護符
  - 5 種稀有度：普通、優良、稀有、史詩、傳說
  - 敵人掉落機制（一般敵人 8-25%，Boss 100%）
  - 自動裝備升級功能
- **背包系統**
  - 初始容量 50 格
  - 背包升級功能（每級 +20 格，最高 10 級 / 250 格）
  - 物品詳情面板（裝備/丟棄/比較）
- **裝備頁面** (`app/equipment.tsx`)
  - 裝備欄位面板
  - 背包升級面板
  - 背包物品格
- **底部導航** (`BottomNav.tsx`)
  - 戰鬥 / 裝備 / 轉生 三個分頁
- **掉落通知** (`LootModal.tsx`)
  - 裝備掉落時顯示 Toast 通知

### 變更
- 存檔版本升級至 `0.3.0`
- `useGameStore` 新增裝備和背包相關狀態與方法
- `types/index.ts` 新增裝備相關型別定義

---

## [v0.2.0] - 2026-01-xx

### 新增
- 玩家角色精靈圖（戰士）
- 自動復活機制（死亡後 1 秒自動回到上一關）
- 美術方向文件

### 變更
- 玩家名稱改為「戰士」

---

## [v0.1.0] - 2026-01-xx

### 新增
- 專案初始化 (Expo + TypeScript + Zustand)
- 基本佈局 (SafeAreaView + TopBar + BattleView + UpgradePanel)
- 遊戲引擎 (100ms tick interval)
- 戰鬥系統 (自動攻擊、傷害計算、暴擊)
- 血條 + 傷害飄字
- 升級面板 (HP/ATK/DEF/SPEED/CRIT)
- 存檔系統 (AsyncStorage)
- 離線獎勵計算
- Netlify 部署設定
